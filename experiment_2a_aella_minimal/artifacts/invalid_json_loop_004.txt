{
  "files": [
    {
      "path": "scripts/generate_design_brief.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nGenerate a sponsor-facing brief summarizing survey design metadata gaps.\n\nThe output is deterministic and driven by repository metadata files so that the\nbrief can be regenerated exactly. Seed is recorded for audit compliance.\n\"\"\"\n\nimport argparse\nimport pathlib\nimport re\nimport sys\nfrom datetime import UTC, datetime\nfrom typing import List, Optional\n\nimport yaml\n\nSEED = 20251016\n\n\ndef _read_text(path: pathlib.Path) -> str:\n    if not path.exists():\n        return \"\"\n    return path.read_text(encoding=\"utf-8\")\n\n\ndef _parse_audit_date(markdown: str) -> Optional[str]:\n    \"\"\"\n    Extract the ISO-formatted date from lines like '- **Date:** 2025-11-03'.\n    \"\"\"\n    match = re.search(r\"- \\*\\*Date:\\*\\*\\s*(\\d{4}-\\d{2}-\\d{2})\", markdown)\n    return match.group(1) if match else None\n\n\ndef _format_gap_summary(design_meta: dict) -> List[str]:\n    required_items = [\n        (\"weight_variable\", \"Calibrated base weight column\"),\n        (\"strata_variable\", \"Stratum identifier\"),\n        (\"cluster_variable\", \"Primary sampling unit identifier\"),\n    ]\n    gaps: List[str] = []\n    for key, label in required_items:\n        value = design_meta.get(key)\n        if value in (None, \"\", []):\n            gaps.append(f\"{label}: missing\")\n        else:\n            gaps.append(f\"{label}: present (`{value}`)\")\n\n    replicate_weights = design_meta.get(\"replicate_weights\", [])\n    if not replicate_weights:\n        gaps.append(\"Replicate weights: missing\")\n    else:\n        joined = \", \".join(str(item) for item in replicate_weights)\n        gaps.append(f\"Replicate weights: present ({joined})\")\n\n    fpc = design_meta.get(\"finite_population_correction\")\n    gaps.append(\n        \"Finite population correction: missing\"\n        if fpc in (None, \"\", [])\n        else f\"Finite population correction: present ({fpc})\"\n    )\n    return gaps\n\n\ndef build_brief(design_path: pathlib.Path,\n                validation_note: pathlib.Path,\n                monitor_note: pathlib.Path) -> str:\n    design_meta = yaml.safe_load(design_path.read_text(encoding=\"utf-8\"))\n\n    dataset = design_meta.get(\"dataset\", \"N/A\")\n    assumption = design_meta.get(\n        \"design_assumption\",\n        \"Simple random sampling until sponsor metadata arrives.\"\n    )\n    notes = design_meta.get(\"notes\", [])\n\n    validation_md = _read_text(validation_note)\n    monitor_md = _read_text(monitor_note)\n\n    validation_date = _parse_audit_date(validation_md)\n    monitor_date = _parse_audit_date(monitor_md)\n\n    audit_lines: List[str] = []\n    if validation_date:\n        audit_lines.append(f\"Initial validation: {validation_date}\")\n    if monitor_date and monitor_date != validation_date:\n        audit_lines.append(f\"Latest monitoring pass: {monitor_date}\")\n    if not audit_lines:\n        audit_lines.append(\"No dated audits recorded.\")\n\n    gaps = _format_gap_summary(design_meta)\n\n    requested_files = [\n        \"Calibrated individual weight file or integrated weight column metadata.\",\n        \"Stratum definitions and primary sampling unit (PSU) identifiers.\",\n        \"Replicate weight specification (e.g., BRR, JK1/JK2) with scaling factors.\",\n        \"Weighting and variance estimation methodology documentation.\",\n        \"Any finite population correction values or universe totals used in calibration.\",\n    ]\n\n    now_iso = datetime.now(UTC).replace(microsecond=0).isoformat()\n\n    lines: List[str] = [\n        \"# Sponsor Brief: Survey Design Metadata\",\n        \"\",\n        f\"- Generated: {now_iso}\",\n        f\"- Seed: {SEED}\",\n        f\"- Dataset: `{dataset}`\",\n        \"\",\n        \"## Current Assumptions\",\n        assumptions_text(assumption, notes),\n        \"\",\n        \"## Metadata Gaps\",\n        *[f\"- {gap}\" for gap in gaps],\n        \"\",\n        \"## Requested Sponsor Deliverables\",\n        *[f\"- {item}\" for item in requested_files],\n        \"\",\n        \"## Audit Trail\",\n        *[f\"- {line}