{
  "files": [
    {
      "path": "analysis/code/social_support_missingness.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nSummarise missingness patterns for candidate social support predictors.\n\nRegeneration example:\npython analysis/code/social_support_missingness.py \\\n    --dataset data/clean/childhoodbalancedpublic_with_csa_indicator.csv \\\n    --out-csv tables/social_support_missingness.csv \\\n    --config config/agent_config.yaml\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nfrom dataclasses import dataclass\nfrom pathlib import Path\nfrom typing import Iterable, List\n\nimport pandas as pd\nimport yaml\n\n\nDEFAULT_COLUMNS: List[str] = [\n    \"In general, people in my *current* social circles tend treat me really well (tmt46e6)\",\n    \"In general, people in my *current* social circles tend to treat me really well (71mn55g)\",\n    \"In general, people in my *current* social circles tend treat me really well\",\n    \"In general, people in my *current* social circles tend to treat me really well\",\n]\n\n\n@dataclass\nclass Config:\n    seed: int = 0\n    small_cell_threshold: int = 10\n\n\ndef parse_args() -> argparse.Namespace:\n    parser = argparse.ArgumentParser(\n        description=\"Compute summary statistics for social support predictor coverage.\"\n    )\n    parser.add_argument(\"--dataset\", required=True, help=\"Input CSV dataset path.\")\n    parser.add_argument(\n        \"--out-csv\",\n        required=True,\n        help=\"Destination CSV with missingness summary.\",\n    )\n    parser.add_argument(\n        \"--columns\",\n        nargs=\"+\",\n        default=DEFAULT_COLUMNS,\n        help=\"Column names to profile (default matches current hypotheses).\",\n    )\n    parser.add_argument(\n        \"--config\", required=False, help=\"Optional config YAML to capture metadata.\"\n    )\n    return parser.parse_args()\n\n\ndef load_config(path: str | None) -> Config:\n    if path is None:\n        return Config()\n    config_path = Path(path)\n    data = yaml.safe_load(config_path.read_text())\n    return Config(\n        seed=int(data.get(\"seed\", 0)),\n        small_cell_threshold=int(data.get(\"small_cell_threshold\", 10)),\n    )\n\n\ndef sanitise_columns(columns: Iterable[str]) -> List[str]:\n    \"\"\"Drop duplicates while preserving order.\"\"\"\n    seen = set()\n    ordered = []\n    for col in columns:\n        if col not in seen:\n            seen.add(col)\n            ordered.append(col)\n    return ordered\n\n\ndef build_summary(\n    df: pd.DataFrame, columns: Iterable[str], threshold: int\n) -> pd.DataFrame:\n    rows = []\n    total = len(df)\n    for col in columns:\n        available = missing = unique = suppression = None\n        if col in df.columns:\n            series = df[col]\n            missing = int(series.isna().sum())\n            available = total - missing\n            unique = int(series.nunique(dropna=True))\n            suppression = \"ok\" if available >= threshold else \"review\"\n        else:\n            missing = total\n            available = 0\n            unique = 0\n            suppression = \"missing_column\"\n        rows.append(\n            {\n                \"variable\": col,\n                \"available_obs\": available,\n                \"missing_obs\": missing,\n                \"missing_pct\": round(missing / total, 6) if total else None,\n                \"unique_values\": unique,\n                \"disclosure_check\": suppression,\n            }\n        )\n    return pd.DataFrame(rows)\n\n\ndef main() -> None:\n    args = parse_args()\n    config = load_config(args.config)\n\n    dataset_path = Path(args.dataset)\n    out_path = Path(args.out_csv)\n\n    df = pd.read_csv(dataset_path, low_memory=False)\n    columns = sanitise_columns(args.columns)\n    summary = build_summary(df, columns, config.small_cell_threshold)\n    summary.to_csv(out_path, index=False)\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "mode": "text"
    },
    {
      "path": "tables/social_support_missingness.csv",
      "content": "variable,available_obs,missing_obs,missing_pct,unique_values,disclosure_check\n\"In general, people in my *current* social circles tend treat me really well (tmt46e6)\",383,14060,0.973482,7,ok\n\"In general, people in my *current* social circles tend to treat me really well (71mn55g)\",14054,389,0.026933,7,ok\n\"In general, people in my *current* social circles tend treat me really well\",383,14060,0.973482,7,ok\n\"In general, people in my *current* social circles tend to treat me really well\",14054,389,0.026933,7,ok\n",
      "mode": "text"
    }