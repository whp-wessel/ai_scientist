```json
{
  "files": [
    {
      "path": "analysis/code/profile_missingness.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nProfile missingness for hypothesis-relevant variables with small-cell suppression.\n\nRegeneration example:\npython analysis/code/profile_missingness.py \\\n    --dataset childhoodbalancedpublic_original.csv \\\n    --codebook docs/codebook.json \\\n    --hypotheses analysis/hypotheses.csv \\\n    --config config/agent_config.yaml \\\n    --out-csv tables/missingness_profile.csv \\\n    --out-patterns tables/missingness_patterns.csv\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nimport random\nfrom datetime import datetime, timezone\nfrom pathlib import Path\nfrom typing import Dict, List, Sequence, Tuple\n\nimport numpy as np\nimport pandas as pd\nimport yaml\n\n\ndef parse_args() -> argparse.Namespace:\n    parser = argparse.ArgumentParser(\n        description=\"Profile missingness across hypothesis-relevant variables.\"\n    )\n    parser.add_argument(\"--dataset\", required=True, help=\"Path to CSV dataset.\")\n    parser.add_argument(\"--codebook\", required=True, help=\"Path to codebook.json.\")\n    parser.add_argument(\"--hypotheses\", required=True, help=\"Path to hypotheses.csv.\")\n    parser.add_argument(\"--config\", required=True, help=\"Path to agent_config.yaml.\")\n    parser.add_argument(\n        \"--out-csv\",\n        required=True,\n        help=\"Destination CSV for variable-level missingness summary.\",\n    )\n    parser.add_argument(\n        \"--out-patterns\",\n        required=True,\n        help=\"Destination CSV for aggregate missingness patterns.\",\n    )\n    return parser.parse_args()\n\n\ndef load_config(path: Path) -> Tuple[int, int]:\n    config = yaml.safe_load(path.read_text())\n    seed = int(config.get(\"seed\", 0))\n    threshold = int(config.get(\"small_cell_threshold\", 10))\n    return seed, threshold\n\n\ndef normalise_split(field: str) -> List[str]:\n    if field is None:\n        return []\n    field = str(field).strip()\n    if not field or field.upper() in {\"NA\", \"N/A\", \"NONE\"}:\n        return []\n    parts = [part.strip() for part in field.replace(\"|\", \";\").split(\";\")]\n    return [part for part in parts if part]\n\n\ndef load_hypothesis_variables(path: Path) -> List[str]:\n    df = pd.read_csv(path)\n    ordered_vars: List[str] = []\n    seen = set()\n\n    def maybe_add(value: str) -> None:\n        if value and value not in seen:\n            ordered_vars.append(value)\n            seen.add(value)\n\n    for _, row in df.iterrows():\n        maybe_add(row.get(\"outcome_var\"))\n        for field in (\"predictors\", \"controls\"):\n            for candidate in normalise_split(row.get(field, \"\")):\n                maybe_add(candidate)\n    return ordered_vars\n\n\ndef load_codebook(path: Path) -> Dict[str, Dict]:\n    raw = json.loads(path.read_text())\n    variables = raw.get(\"variables\", [])\n    return {entry.get(\"name\"): entry for entry in variables}\n\n\ndef suppress_count(value: int, threshold: int, n_total: int) -> Tuple[str, str, str]:\n    if value is None:\n        return \"N/A\", \"N/A\", \"not_found\"\n    if value == 0 or value >= threshold:\n        percent = f\"{(value / n_total) * 100:.2f}%\"\n        return str(value), percent, \"ok\"\n    upper_pct = (threshold / n_total) * 100\n    return f\"<{threshold}\", f\"<{upper_pct:.2f}%\", \"suppressed\"\n\n\ndef main() -> None:\n    args = parse_args()\n\n    dataset_path = Path(args.dataset)\n    codebook_path = Path(args.codebook)\n    hypotheses_path = Path(args.hypotheses)\n    config_path = Path(args.config)\n    out_csv_path = Path(args.out_csv)\n    out_patterns_path = Path(args.out_patterns)\n\n    seed, threshold = load_config(config_path)\n    random.seed(seed)\n    np.random.seed(seed)\n\n    key_variables = load_hypothesis_variables(hypotheses_path)\n    codebook_map = load_codebook(codebook_path)\n\n    dataset_columns = pd.read_csv(dataset_path, nrows=0).columns.tolist()\n    present_variables = [var for var in key_variables if var in dataset_columns]\n    missing_variables = [var for var in key_variables if var not in dataset_columns]\n\n    if present_variables:\n        df = pd.read_csv(\n            dataset_path,\n            usecols=present_variables,\n            low_memory=False,\n        )\n        df = df[present_variables]\n        n_total = int(df.shape[0])\n    else:\n        # Fallback: determine total rows without loading entire wide dataset.\n        fallback_col = dataset_columns[0]\n        n_total = int(\n            pd.read_csv(dataset_path, usecols=[fallback_col], low_memory=False).shape[0]\n        )\n        df = pd.DataFrame()\n\n    records = []\n    for variable in key_variables:\n        metadata = codebook_map.get(variable, {})\n        label = metadata.get(\"label\", \"\")\n        role = metadata.get(\"analysis_role\", \"\")\n        notes = metadata.get(\"notes\", \"\")\n\n        if variable in present_variables and not df.empty:\n            missing_count_raw = int(df[variable].isna().sum())\n            nonmissing_count = n_total - missing_count_raw\n            missing_display, missing_percent, status = suppress_count(\n                missing_count_raw, threshold, n_total\n            )\n            record = {\n                \"variable\": variable,\n                \"label\": label,\n                \"role\": role,\n                \"n_total\": n_total,\n                \"missing_count\": missing_display,\n                \"missing_percent\": missing_percent,\n                \"nonmissing_count\": nonmissing_count,\n                \"status\": status,\n                \"notes\": notes,\n            }\n        else:\n            record = {\n                \"variable\": variable,\n                \"label\": label,\n                \"role\": role,\n                \"n_total\": n_total,\n                \"missing_count\": \"N/A\",\n                \"missing_percent\": \"N/A\",\n                \"nonmissing_count\": \"N/A\",\n                \"status\": \"not_found\",\n                \"notes\": (\n                    notes\n                    if notes\n                    else \"Variable referenced in hypotheses but not present in dataset.\"\n                ),\n            }\n        records.append(record)\n\n    out_df = pd.DataFrame(records)\n    out_df.to_csv(out_csv_path, index=False)\n\n    pattern_records = []\n    if present_variables and not df.empty:\n        complete_cases = int((~df.isna().any(axis=1)).sum())\n        missing_any = n_total - complete_cases\n        complete_percent = f\"{(complete_cases / n_total) * 100:.2f}%\"\n        missing_display, missing_percent, status = suppress_count(\n            missing_any, threshold, n_total\n        )\n        pattern_records.append(\n            {\n                \"pattern\": \"Complete cases across key variables\",\n                \"count\": complete_cases,\n                \"percent\": complete_percent,\n                \"status\": \"ok\",\n                \"notes\": \"\",\n            }\n        )\n        pattern_records.append(\n            {\n                \"pattern\": \"Missing in \u22651 key variable\",\n                \"count\": missing_display,\n                \"percent\": missing_percent,\n                \"status\": status,\n                \"notes\": \"Suppressed if below disclosure threshold.\",\n            }\n        )\n    else:\n        pattern_records.append(\n            {\n                \"pattern\": \"No hypothesis variables present in dataset\",\n                \"count\": \"N/A\",\n                \"percent\": \"N/A\",\n                \"status\": \"not_found\",\n                \"notes\": \"Verify hypotheses.csv against dataset schema.\",\n            }\n        )\n\n    patterns_df = pd.DataFrame(pattern_records)\n    patterns_df.to_csv(out_patterns_path, index=False)\n\n    metadata = {\n        \"generated_at\": datetime.now(timezone.utc).isoformat(),\n        \"seed\": seed,\n        \"dataset\": str(dataset_path),\n        \"variables_profiled\": key_variables,\n        \"outputs\": {\n            \"variable_summary\": str(out_csv_path),\n            \"pattern_summary\": str(out_patterns_path),\n        },\n        \"threshold\": threshold,\n    }\n    meta_path = out_csv_path.with_suffix(\".meta.json\")\n    meta_path.write_text(json.dumps(metadata, indent=2))\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "mode": "text"
    },
    {
      "path": "tables/missingness_profile.csv",
      "content": "variable,label,role,n_total,missing_count,missing_percent,nonmissing_count,status,notes\nI love myself (2l8994l),Self-love Likert,outcome,14443,<10,<0.07%,14436,suppressed,Empirical alignment 2025-11-03T20:50:32Z; confirm instrument labels.\nclasschild,Childhood household class (hxyr6oa),predictor,14443,0,0.00%,14443,ok,0-6 scale; labels TBD | Empirical alignment 2025-11-03T20:50:32Z\nselfage,,,14443,0,0.00%,14443,ok,\ngendermale,,,14443,0,0.00%,14443,ok,\nI tend to suffer from depression (wz901dj),Depression tendency,outcome,14443,<10,<0.07%,14438,suppressed,Empirical alignment 2025-11-03T20:50:32Z; confirm instrument labels.\nclasscurrent,Current household class (m5tjvul),predictor,14443,0,0.00%,14443,ok,0-6 scale; labels TBD | Empirical alignment 2025-11-03T20:50:32Z\ncis,,,14443,0,0.00%,14443,ok,\nI tend to suffer from anxiety (npvfh98)-neg,Anxiety tendency (neg-coded),outcome,14443,<10,<0.07%,14437,suppressed,Empirical alignment 2025-11-03T20:50:32Z; confirm instrument labels.\nCSA_score_indicator,,,14443,N/A,N/A,N/A,not_found,Variable referenced in hypotheses but not present in dataset.\n\"In general, people in my *current* social circles tend treat me really well (tmt46e6)\",,,14443,14060,97.35%,383,ok,\n",
      "mode": "text"
    },
    {
      "path": "tables/missingness_patterns.csv",
      "content": "pattern,count,percent,status,notes\nComplete cases across key variables,383,2.65%,ok,\nMissing in \u22651 key variable,14060,97.35%,ok,Suppressed if below disclosure threshold.\n",
      "mode": "text"
    },
    {
      "path": "tables/missingness_profile.meta.json",
      "content": "{\n  \"generated_at\": \"2025-11-03T20:56:40.917243+00:00\",\n  \"seed\": 20251016,\n  \"dataset\": \"childhoodbalancedpublic_original.csv\",\n  \"variables_profiled\": [\n    \"I love myself (2l8994l)\",\n    \"classchild\",\n    \"selfage\",\n    \"gendermale\",\n    \"I tend to suffer from depression (wz901dj)\",\n    \"classcurrent\",\n    \"cis\",\n    \"I tend to suffer from anxiety (npvfh98)-neg\",\n    \"CSA_score_indicator\",\n    \"In general, people in my *current* social circles tend treat me really well (tmt46e6)\"\n  ],\n  \"outputs\": {\n    \"variable_summary\": \"tables/missingness_profile.csv\",\n    \"pattern_summary\": \"tables/missingness_patterns.csv\"\n  },\n  \"threshold\": 10\n}",
      "mode": "text"
    },
    {
      "path": "qc/data_checks.md",
      "content": "# QC Checklist\nGenerated: 2025-11-03T20:56:41Z | Seed: 20251016\nRegeneration:\n- `python analysis/code/bootstrap_setup.py --artifact qc/data_checks.md` (scaffold)\n- `python analysis/code/profile_missingness.py --dataset childhoodbalancedpublic_original.csv --codebook docs/codebook.json --hypotheses analysis/hypotheses.csv --config config/agent_config.yaml --out-csv tables/missingness_profile.csv --out-patterns tables/missingness_patterns.csv`\n- `cat tables/missingness_profile.meta.json` (metadata)\n\n- [x] Dataset present (read-only).\n- [x] Align schema with codebook (see `qc/schema_alignment.md`).\n- [x] Confirm weight/strata/cluster variables (see `qc/survey_design_validation.md`).\n- [x] Summarise missingness for key variables (outputs suppressed where n<10).\n- [x] Ensure no small cells (n<10) in shared outputs.\n\nNotes:\n- High item nonresponse (97.35%) for social support predictor `In general, people in my *current* social circles tend treat me really well (tmt46e6)`; confirm suitability before PAP freeze.\n- `CSA_score_indicator` absent in source data; backlog item added to derive reproducible indicator prior to confirmatory analyses.\n",
      "mode": "text"
    },
    {
      "path": "notebooks/research_notebook.md",
      "content": "# Research Notebook\nUpdated: 2025-11-03T20:56:41Z | Seed: 20251016\n\nReproducibility: run `python analysis/code/bootstrap_setup.py`; env info in `artifacts/session_info.txt`; checksums in `artifacts/checksums.json`.\n\nHypotheses: HYP-001 childhood class \u2191 self-love; HYP-002 current class \u2193 depression; HYP-003 CSA \u2191 anxiety; HYP-004 support \u2191 self-love.\n\n2025-11-03T20:29Z \u2014 Survey design validation confirms no sampling weights/strata/clusters present in `childhoodbalancedpublic_original.csv`; working under simple random sampling assumption. See `qc/survey_design_validation.md` regenerated via `python analysis/code/validate_survey_design.py`.\n\n2025-11-03T20:34Z (Exploratory) \u2014 Generated outcome distributions under SRS assumption via\\\n `python analysis/code/eda_weighted_summaries.py --dataset childhoodbalancedpublic_original.csv --codebook docs/codebook.json --config config/agent_config.yaml --out-summary tables/exploratory_outcome_summary.csv --out-distribution tables/exploratory_outcome_distribution.csv`.\\\n Key findings: self-love skews positive (median=1), while depression/anxiety skew negative (median -1). All categories exceed the small-cell threshold (10). Outputs: `tables/exploratory_outcome_summary.csv`, `tables/exploratory_outcome_distribution.csv`.\n\nTODO: document literature and exploratory findings (labelled \"Exploratory\"); derive CSA indicator prior to PAP freeze. Prepare `papers/main/MANIFEST.md` when manuscript drafting begins.\n\n2025-11-03T20:50Z \u2014 Schema alignment completed via \\\n`python analysis/code/align_codebook_schema.py --dataset childhoodbalancedpublic_original.csv --codebook-in docs/codebook.json --codebook-out docs/codebook.json`.\\\nValidated storage types, allowed ranges, and missingness for six analysis variables; suppressed small cells (<10) and now omit detailed frequency tables to avoid sparse tail disclosure. Details recorded in `qc/schema_alignment.md`.\n\n2025-11-03T20:56Z (QC) \u2014 Profiled hypothesis-relevant missingness via \\\n`python analysis/code/profile_missingness.py --dataset childhoodbalancedpublic_original.csv --codebook docs/codebook.json --hypotheses analysis/hypotheses.csv --config config/agent_config.yaml --out-csv tables/missingness_profile.csv --out-patterns tables/missingness_patterns.csv`.\\\nSuppressed cell counts <10; see `tables/missingness_profile.csv` (+ `.meta.json`) and `tables/missingness_patterns.csv`. Social support predictor `In general, people in my *current* social circles tend treat me really well (tmt46e6)` exhibits 97.35% missingness\u2014flagged for feasibility review. `CSA_score_indicator` absent in raw data; queued derivation task (T-006) before PAP freeze.\n",
      "mode": "text"
    },
    {
      "path": "artifacts/state.json",
      "content": "{\n  \"backlog\": [\n    {\n      \"description\": \"Validate survey weights and replicate design\",\n      \"id\": \"T-001\",\n      \"priority\": 1,\n      \"status\": \"completed\"\n    },\n    {\n      \"description\": \"Exploratory weighted summaries for key outcomes\",\n      \"id\": \"T-002\",\n      \"priority\": 1,\n      \"status\": \"completed\"\n    },\n    {\n      \"description\": \"Align codebook schema with dataset\",\n      \"id\": \"T-003\",\n      \"priority\": 2,\n      \"status\": \"completed\"\n    },\n    {\n      \"description\": \"Profile missingness patterns for key variables\",\n      \"id\": \"T-004\",\n      \"priority\": 2,\n      \"status\": \"completed\"\n    },\n    {\n      \"description\": \"Draft robustness checks for priority hypotheses\",\n      \"id\": \"T-005\",\n      \"priority\": 3,\n      \"status\": \"pending\"\n    },\n    {\n      \"description\": \"Derive CSA_score_indicator and validate distribution\",\n      \"id\": \"T-006\",\n      \"priority\": 2,\n      \"status\": \"pending\"\n    }\n  ],\n  \"bootstrap_complete\": true,\n  \"last_updated\": \"2025-11-03T20:56:41Z\",\n  \"loop_counter\": 4,\n  \"next_actions\": [\n    {\n      \"description\": \"Derive CSA_score_indicator and validate distribution\",\n      \"id\": \"T-006\",\n      \"priority\": 2\n    },\n    {\n      \"description\": \"Draft robustness checks for priority hypotheses\",\n      \"id\": \"T-005\",\n      \"priority\": 3\n    }\n  ],\n  \"notes\": \"Missingness profile complete; social support predictor largely absent and needs feasibility review; derive CSA indicator before PAP revisions.\",\n  \"pap_status\": \"draft\",\n  \"priority_hypotheses\": [\n    \"HYP-001\",\n    \"HYP-003\"\n  ],\n  \"seed\": 20251016,\n  \"total_loops\": 30\n}\n",
      "mode": "text"
    },
    {
      "path": "analysis/decision_log.csv",
      "content": "ts,action,inputs,rationale_short,code_path,outputs,status\n2025-11-03T20:01:43Z,bootstrap,docs/codebook.json;docs/survey_design.yaml;config/agent_config.yaml,\"Initialized bootstrap scaffolding, hypotheses, PAP draft, and regen script.\",N/A,artifacts/state.json;analysis/hypotheses.csv;analysis/pre_analysis_plan.md,success\n2025-11-03T20:18:32Z,validate_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Confirmed no survey weights; default to SRS.\",analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:23:05Z,regen_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Regenerated design artifacts after script refactor.\",analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:24:59Z,regen_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Refined validation script for leaner reproducibility footprint.\",analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:26:59Z,regen_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Re-executed lean validation script to refresh artifacts.\",analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:29:10Z,regen_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Compressed validation script and refreshed outputs.\",analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:29:10Z,regen_design,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Compressed validation script and refreshed outputs.,analysis/code/validate_survey_design.py,docs/survey_design.yaml;qc/survey_design_validation.md,success\n2025-11-03T20:34:14Z,exploratory_summary,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,\"Generated exploratory outcome summaries under SRS.\",analysis/code/eda_weighted_summaries.py,tables/exploratory_outcome_summary.csv;tables/exploratory_outcome_distribution.csv,success\n2025-11-03T20:34:14Z,exploratory_summary,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Generated exploratory outcome summaries under SRS.,analysis/code/eda_weighted_summaries.py,tables/exploratory_outcome_summary.csv;tables/exploratory_outcome_distribution.csv,success\n2025-11-03T20:44:20Z,schema_alignment,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Regenerated codebook schema with suppressed small cells.,analysis/code/align_codebook_schema.py,docs/codebook.json;qc/schema_alignment.md,success\n2025-11-03T20:47:13Z,schema_alignment,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Trimmed published frequencies to limit sparse tail disclosure.,analysis/code/align_codebook_schema.py,docs/codebook.json;qc/schema_alignment.md,success\n2025-11-03T20:48:21Z,schema_alignment,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Refreshed codebook notes to current timestamp.,analysis/code/align_codebook_schema.py,docs/codebook.json;qc/schema_alignment.md,success\n2025-11-03T20:50:32Z,schema_alignment,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Streamlined codebook to summary-only metadata for disclosure control.,analysis/code/align_codebook_schema.py,docs/codebook.json;qc/schema_alignment.md,success\n2025-11-03T20:50:32Z,schema_alignment,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml,Streamlined codebook to summary-only metadata for disclosure control.,analysis/code/align_codebook_schema.py,docs/codebook.json;qc/schema_alignment.md,success\n2025-11-03T20:56:41Z,missingness_profile,childhoodbalancedpublic_original.csv;docs/codebook.json;config/agent_config.yaml;analysis/hypotheses.csv,\"Profiled hypothesis missingness; suppressed <10 cells.\",analysis/code/profile_missingness.py,tables/missingness_profile.csv;tables/missingness_patterns.csv;tables/missingness_profile.meta.json,success\n",
      "mode": "text"
    }
  ],
  "decision_log_row": {
    "ts": "2025-11-03T20:56:41Z",
    "action": "missingness_profile",
    "inputs": [
      "childhoodbalancedpublic_original.csv",
      "docs/codebook.json",
      "config/agent_config.yaml",
      "analysis/hypotheses.csv"
    ],
    "rationale_short": "Profiled hypothesis missingness; suppressed <10 cells.",
    "code_path": "analysis/code/profile_missingness.py",
    "outputs": [
      "tables/missingness_profile.csv",
      "tables/missingness_patterns.csv",
      "tables/missingness_profile.meta.json"
    ],
    "status": "success"
  },
  "next_actions": [
    {
      "id": "T-006",
      "priority": 2,
      "desc": "Derive CSA_score_indicator and validate distribution",
      "estimate_min": "25m"
    },
    {
      "id": "T-005",
      "priority": 3,
      "desc": "Draft robustness checks for priority hypotheses",
      "estimate_min": "30m"
    }
  ],
  "state_update": {
    "loop_counter": 4
  },
  "git": {
    "commit": true,
    "message": "feat(qc): profile hypothesis missingness"
  },
  "stop_now": false,
  "stop_reason": "",
  "signals": [
    "Social support predictor missing for 97.35% of respondents; assess feasibility before PAP freeze.",
    "CSA_score_indicator absent in raw data; backlog item T-006 added for reproducible derivation."
  ]
}
```