```json
{
  "files": [
    {
      "path": "scripts/generate_design_brief.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nGenerate a sponsor-facing brief summarizing survey design metadata gaps.\n\nThe output is deterministic and driven by repository metadata files so that the\nbrief can be regenerated exactly. Seed is recorded for audit compliance.\n\"\"\"\n\nimport argparse\nimport pathlib\nimport re\nimport sys\nfrom datetime import UTC, datetime\nfrom typing import List, Optional\n\nimport yaml\n\nSEED = 20251016\n\n\ndef _read_text(path: pathlib.Path) -> str:\n    if not path.exists():\n        return \"\"\n    return path.read_text(encoding=\"utf-8\")\n\n\ndef _parse_audit_date(markdown: str) -> Optional[str]:\n    \"\"\"\n    Extract the ISO-formatted date from lines like '- **Date:** 2025-11-03'.\n    \"\"\"\n    match = re.search(r\"- \\*\\*Date:\\*\\*\\s*(\\d{4}-\\d{2}-\\d{2})\", markdown)\n    return match.group(1) if match else None\n\n\ndef _format_gap_summary(design_meta: dict) -> List[str]:\n    required_items = [\n        (\"weight_variable\", \"Calibrated base weight column\"),\n        (\"strata_variable\", \"Stratum identifier\"),\n        (\"cluster_variable\", \"Primary sampling unit identifier\"),\n    ]\n    gaps: List[str] = []\n    for key, label in required_items:\n        value = design_meta.get(key)\n        if value in (None, \"\", []):\n            gaps.append(f\"{label}: missing\")\n        else:\n            gaps.append(f\"{label}: present (`{value}`)\")\n\n    replicate_weights = design_meta.get(\"replicate_weights\", [])\n    if not replicate_weights:\n        gaps.append(\"Replicate weights: missing\")\n    else:\n        joined = \", \".join(str(item) for item in replicate_weights)\n        gaps.append(f\"Replicate weights: present ({joined})\")\n\n    fpc = design_meta.get(\"finite_population_correction\")\n    gaps.append(\n        \"Finite population correction: missing\"\n        if fpc in (None, \"\", [])\n        else f\"Finite population correction: present ({fpc})\"\n    )\n    return gaps\n\n\ndef build_brief(design_path: pathlib.Path,\n                validation_note: pathlib.Path,\n                monitor_note: pathlib.Path) -> str:\n    design_meta = yaml.safe_load(design_path.read_text(encoding=\"utf-8\"))\n\n    dataset = design_meta.get(\"dataset\", \"N/A\")\n    assumption = design_meta.get(\n        \"design_assumption\",\n        \"Simple random sampling until sponsor metadata arrives.\"\n    )\n    notes = design_meta.get(\"notes\", [])\n\n    validation_md = _read_text(validation_note)\n    monitor_md = _read_text(monitor_note)\n\n    validation_date = _parse_audit_date(validation_md)\n    monitor_date = _parse_audit_date(monitor_md)\n\n    audit_lines: List[str] = []\n    if validation_date:\n        audit_lines.append(f\"Initial validation: {validation_date}\")\n    if monitor_date and monitor_date != validation_date:\n        audit_lines.append(f\"Latest monitoring pass: {monitor_date}\")\n    if not audit_lines:\n        audit_lines.append(\"No dated audits recorded.\")\n\n    gaps = _format_gap_summary(design_meta)\n\n    requested_files = [\n        \"Calibrated individual weight file or integrated weight column metadata.\",\n        \"Stratum definitions and primary sampling unit (PSU) identifiers.\",\n        \"Replicate weight specification (e.g., BRR, JK1/JK2) with scaling factors.\",\n        \"Weighting and variance estimation methodology documentation.\",\n        \"Any finite population correction values or universe totals used in calibration.\",\n    ]\n\n    now_iso = datetime.now(UTC).replace(microsecond=0).isoformat()\n\n    lines: List[str] = [\n        \"# Sponsor Brief: Survey Design Metadata\",\n        \"\",\n        f\"- Generated: {now_iso}\",\n        f\"- Seed: {SEED}\",\n        f\"- Dataset: `{dataset}`\",\n        \"\",\n        \"## Current Assumptions\",\n        assumptions_text(assumption, notes),\n        \"\",\n        \"## Metadata Gaps\",\n        *[f\"- {gap}\" for gap in gaps],\n        \"\",\n        \"## Requested Sponsor Deliverables\",\n        *[f\"- {item}\" for item in requested_files],\n        \"\",\n        \"## Audit Trail\",\n        *[f\"- {line}\" for line in audit_lines],\n        \"\",\n        \"## Reproducibility\",\n        \"To regenerate this brief, run:\",\n        \"```bash\",\n        \"python scripts/generate_design_brief.py --out reports/design_metadata_brief.md\",\n        \"```\",\n        \"\",\n        \"This script is deterministic and relies on the metadata files referenced above.\",\n    ]\n    return \"\\n\".join(lines)\n\n\ndef assumptions_text(assumption: str, notes: List[str]) -> str:\n    parts: List[str] = [assumption]\n    if notes:\n        formatted = \"; \".join(note.strip() for note in notes)\n        parts.append(f\"Notes: {formatted}\")\n    return \" \".join(parts)\n\n\ndef main(argv: Optional[List[str]] = None) -> int:\n    parser = argparse.ArgumentParser(\n        description=\"Generate sponsor brief summarizing survey design metadata gaps.\"\n    )\n    parser.add_argument(\n        \"--design\", default=\"docs/survey_design.yaml\",\n        help=\"Path to survey design YAML metadata.\"\n    )\n    parser.add_argument(\n        \"--validation-note\", default=\"qc/design_validation.md\",\n        help=\"Path to the initial design validation markdown notes.\"\n    )\n    parser.add_argument(\n        \"--monitor-note\", default=\"qc/design_metadata_monitor.md\",\n        help=\"Path to the latest monitoring note.\"\n    )\n    parser.add_argument(\n        \"--out\", default=\"reports/design_metadata_brief.md\",\n        help=\"Output markdown path for the sponsor brief.\"\n    )\n\n    args = parser.parse_args(argv)\n\n    design_path = pathlib.Path(args.design)\n    if not design_path.exists():\n        raise FileNotFoundError(f\"Missing design metadata: {design_path}\")\n\n    output_path = pathlib.Path(args.out)\n    output_path.parent.mkdir(parents=True, exist_ok=True)\n\n    brief = build_brief(\n        design_path=design_path,\n        validation_note=pathlib.Path(args.validation_note),\n        monitor_note=pathlib.Path(args.monitor_note),\n    )\n    output_path.write_text(brief, encoding=\"utf-8\")\n    return 0\n\n\nif __name__ == \"__main__\":\n    sys.exit(main())\n",
      "mode": "text"
    },
    {
      "path": "reports/design_metadata_brief.md",
      "content": "# Sponsor Brief: Survey Design Metadata\n\n- Generated: 2025-11-03T20:13:09+00:00\n- Seed: 20251016\n- Dataset: `childhoodbalancedpublic_original.csv`\n\n## Current Assumptions\nTreat as simple random sample until sponsor provides design metadata. Notes: 2025-01-17: python scripts/design_scan.py (see qc/design_validation.md) found no survey weight or replicate columns.; Variance estimation defaults to Taylor linearization with equal weights.; Revisit once codebook metadata or sponsor indicates design weights/strata.; 2025-11-03: Re-ran scripts/design_scan.py (qc/design_metadata_monitor.md); still no sponsor design metadata or calibrated weights.\n\n## Metadata Gaps\n- Calibrated base weight column: missing\n- Stratum identifier: missing\n- Primary sampling unit identifier: missing\n- Replicate weights: missing\n- Finite population correction: missing\n\n## Requested Sponsor Deliverables\n- Calibrated individual weight file or integrated weight column metadata.\n- Stratum definitions and primary sampling unit (PSU) identifiers.\n- Replicate weight specification (e.g., BRR, JK1/JK2) with scaling factors.\n- Weighting and variance estimation methodology documentation.\n- Any finite population correction values or universe totals used in calibration.\n\n## Audit Trail\n- Initial validation: 2025-01-17\n- Latest monitoring pass: 2025-11-03\n\n## Reproducibility\nTo regenerate this brief, run:\n```bash\npython scripts/generate_design_brief.py --out reports/design_metadata_brief.md\n```\n\nThis script is deterministic and relies on the metadata files referenced above.",
      "mode": "text"
    },
    {
      "path": "artifacts/state.json",
      "content": "{\n  \"artifacts\": {\n    \"hypotheses_registry\": \"analysis/hypotheses.csv\",\n    \"pre_analysis_plan\": \"analysis/pre_analysis_plan.md\",\n    \"research_notebook\": \"notebooks/research_notebook.md\",\n    \"design_metadata_brief\": \"reports/design_metadata_brief.md\"\n  },\n  \"backlog\": [\n    {\n      \"description\": \"Validate survey weights and replicate design metadata\",\n      \"id\": \"T-001\",\n      \"priority\": 1,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Generate exploratory weighted summaries for key outcomes\",\n      \"id\": \"T-002\",\n      \"priority\": 2,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Monitor for sponsor-provided survey design metadata updates\",\n      \"id\": \"T-003\",\n      \"priority\": 3,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Draft sponsor-ready brief summarizing design metadata gaps and needed files\",\n      \"id\": \"T-004\",\n      \"priority\": 3,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Follow up with sponsor on requested design deliverables\",\n      \"id\": \"T-005\",\n      \"priority\": 1,\n      \"status\": \"todo\"\n    },\n    {\n      \"description\": \"Update design files upon receipt of sponsor metadata\",\n      \"id\": \"T-006\",\n      \"priority\": 3,\n      \"status\": \"blocked\"\n    }\n  ],\n  \"bootstrap_complete\": true,\n  \"loop_counter\": 4,\n  \"next_actions\": [\n    \"T-005\"\n  ],\n  \"regeneration_commands\": {\n    \"bootstrap\": \"python scripts/bootstrap_artifacts.py\",\n    \"design_validation\": \"python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv\",\n    \"exploratory_summaries\": \"python scripts/exploratory_summaries.py --csv childhoodbalancedpublic_original.csv --config config/agent_config.yaml --out tables/summary_key_outcomes.csv\",\n    \"design_monitoring\": \"python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv\",\n    \"design_brief\": \"python scripts/generate_design_brief.py --out reports/design_metadata_brief.md\"\n  },\n  \"seed\": 20251016,\n  \"total_loops\": 30\n}\n",
      "mode": "text"
    },
    {
      "path": "analysis/decision_log.csv",
      "content": "ts,action,inputs,rationale_short,code_path,outputs,status\n2025-11-03T17:46:46Z,bootstrap,\"[docs/codebook.json;docs/survey_design.yaml;config/agent_config.yaml]\",\"Initialized bootstrap artifacts and backlog\",\"scripts/bootstrap_artifacts.py\",\"[artifacts/state.json;analysis/hypotheses.csv;analysis/pre_analysis_plan.md]\",\"success\"\n2025-11-03T17:46:46Z,bootstrap,docs/codebook.json;docs/survey_design.yaml;config/agent_config.yaml,\"Seeded bootstrap artifacts, backlog, hypotheses, notebook scaffolds.\",scripts/bootstrap_artifacts.py,artifacts/state.json;analysis/hypotheses.csv;analysis/pre_analysis_plan.md,success\n2025-01-17T15:42:00Z,T-001 design validation,\"[childhoodbalancedpublic_original.csv;docs/survey_design.yaml;config/agent_config.yaml]\",\"Confirmed absence of design weights; assumed SRS defaults.\",\"scripts/design_scan.py\",\"[docs/survey_design.yaml;config/agent_config.yaml;qc/design_validation.md;artifacts/state.json]\",success\n2025-11-03T20:02:35Z,T-002 exploratory summaries,\"childhoodbalancedpublic_original.csv;config/agent_config.yaml\",\"Generated deterministic key outcome summaries under SRS assumption.\",scripts/exploratory_summaries.py,\"tables/summary_key_outcomes.csv;tables/summary_key_outcomes.json\",success\n2025-11-03T20:02:35Z,T-002 exploratory summaries,childhoodbalancedpublic_original.csv;config/agent_config.yaml,Created deterministic summaries for key outcomes under SRS assumption.,scripts/exploratory_summaries.py,tables/summary_key_outcomes.csv;tables/summary_key_outcomes.json,success\n2025-11-03T20:08:03Z,T-003 design monitoring,\"[docs/survey_design.yaml;qc/design_metadata_monitor.md]\",\"Re-audited sponsor design metadata channels; no new weights.\",\"python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv\",\"[docs/survey_design.yaml;qc/design_metadata_monitor.md;artifacts/state.json;qc/data_checks.md]\",success\n2025-11-03T20:13:30Z,T-004 sponsor brief,\"[docs/survey_design.yaml;qc/design_validation.md;qc/design_metadata_monitor.md]\",\"Generated sponsor brief outlining missing design metadata and requested files.\",\"scripts/generate_design_brief.py\",\"[reports/design_metadata_brief.md;artifacts/state.json]\",success\n",
      "mode": "text"
    }
  ],
  "decision_log_row": {
    "ts": "2025-11-03T20:13:30Z",
    "action": "T-004 sponsor brief",
    "inputs": [
      "docs/survey_design.yaml",
      "qc/design_validation.md",
      "qc/design_metadata_monitor.md"
    ],
    "rationale_short": "Generated sponsor brief outlining missing design metadata and requested files.",
    "code_path": "scripts/generate_design_brief.py",
    "outputs": [
      "reports/design_metadata_brief.md",
      "artifacts/state.json"
    ],
    "status": "success"
  },
  "next_actions": [
    {
      "id": "T-005",
      "priority": 1,
      "desc": "Coordinate with sponsor to deliver requested design metadata packet",
      "estimate_min": "30m"
    },
    {
      "id": "T-006",
      "priority": 3,
      "desc": "Stage update workflow to ingest sponsor design files when available",
      "estimate_min": "25m"
    }
  ],
  "state_update": {
    "loop_counter": 4
  },
  "git": {
    "commit": true,
    "message": "feat(report): add sponsor design metadata brief and backlog updates"
  },
  "stop_now": false,
  "stop_reason": "",
  "signals": [
    "Delivered deterministic sponsor brief covering outstanding survey design metadata gaps.",
    "Awaiting sponsor response with weight, strata, PSU, replicate, and FPC documentation."
  ]
}
```