```json
{
  "files": [
    {
      "path": "scripts/exploratory_summaries.py",
      "content": "#!/usr/bin/env python3\n\"\"\"Deterministic exploratory summaries for key survey outcomes.\n\nReads the primary survey CSV, computes unweighted summaries for priority\nvariables, and writes a manifest-friendly CSV table. All operations are\ndeterministic and respect the configured minimum cell size to avoid\nrevealing small-N cells.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport argparse\nimport json\nimport math\nimport random\nfrom dataclasses import dataclass\nfrom pathlib import Path\nfrom typing import Any, Dict, List, Optional\n\nimport numpy as np\nimport pandas as pd\nimport yaml\n\n\n@dataclass(frozen=True)\nclass VariableSpec:\n    alias: str\n    column: str\n    var_type: str\n    note: str = \"\"\n\n\nKEY_VARIABLES: List[VariableSpec] = [\n    VariableSpec(\n        alias=\"selfage\",\n        column=\"selfage\",\n        var_type=\"numeric\",\n        note=\"Respondent age in years.\",\n    ),\n    VariableSpec(\n        alias=\"biomale\",\n        column=\"biomale\",\n        var_type=\"binary\",\n        note=\"1=Biologically male; 0=otherwise. Confirm coding in codebook.\",\n    ),\n    VariableSpec(\n        alias=\"religion_current\",\n        column=\"religion\",\n        var_type=\"binary\",\n        note=\"1=Currently practices a religion; 0=otherwise.\",\n    ),\n    VariableSpec(\n        alias=\"externalreligion_importance\",\n        column=\"externalreligion\",\n        var_type=\"ordinal\",\n        note=\"Importance of childhood religious adherence. Treated as ordered numeric scale.\",\n    ),\n    VariableSpec(\n        alias=\"networth_bracket\",\n        column=\"networth\",\n        var_type=\"ordinal\",\n        note=\"Current net worth bracket codes (higher=greater net worth).\",\n    ),\n    VariableSpec(\n        alias=\"h33e6gg_adult_vs_child_happiness\",\n        column=\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",\n        var_type=\"ordinal\",\n        note=\"Higher values indicate greater adult vs childhood happiness; verify scale direction.\",\n    ),\n]\n\n\ndef load_yaml_config(path: Path) -> Dict[str, Any]:\n    if not path.exists():\n        return {}\n    with path.open(\"r\", encoding=\"utf-8\") as fh:\n        data = yaml.safe_load(fh)\n    return data or {}\n\n\ndef resolve_min_cell_size(config: Dict[str, Any], override: Optional[int]) -> int:\n    if override is not None:\n        return int(override)\n    try:\n        return int(config.get(\"privacy\", {}).get(\"min_cell_size\", 10))\n    except (TypeError, ValueError):\n        return 10\n\n\ndef resolve_seed(config: Dict[str, Any], default_seed: int = 20251016) -> int:\n    value = config.get(\"seed\", default_seed)\n    try:\n        return int(value)\n    except (TypeError, ValueError):\n        return default_seed\n\n\ndef suppress_value(note: str) -> Dict[str, Any]:\n    return {\n        \"value\": \"suppressed_lt_10\",\n        \"note\": note,\n    }\n\n\ndef summarise_numeric(series: pd.Series, min_cell: int) -> List[Dict[str, Any]]:\n    clean = series.dropna()\n    n = int(clean.shape[0])\n    if n < min_cell:\n        return [\n            {\n                \"statistic\": \"all_stats\",\n                \"value\": \"suppressed_lt_10\",\n                \"unweighted_n\": n,\n                \"detail\": \"Suppressed: non-missing N below privacy threshold.\",\n            }\n        ]\n\n    quantiles = clean.quantile([0.25, 0.5, 0.75])\n    stats = {\n        \"mean\": clean.mean(),\n        \"std\": clean.std(ddof=1) if n > 1 else float(\"nan\"),\n        \"min\": clean.min(),\n        \"q1\": quantiles.loc[0.25],\n        \"median\": quantiles.loc[0.5],\n        \"q3\": quantiles.loc[0.75],\n        \"max\": clean.max(),\n    }\n    rows: List[Dict[str, Any]] = []\n    for key, value in stats.items():\n        val = \"\" if value is None or (isinstance(value, float) and math.isnan(value)) else round(float(value), 4)\n        rows.append({\"statistic\": key, \"value\": val, \"unweighted_n\": n})\n\n    missing_fraction = 1.0 - (n / series.shape[0])\n    rows.append(\n        {\n            \"statistic\": \"missing_fraction\",\n            \"value\": round(float(missing_fraction), 4),\n            \"unweighted_n\": series.shape[0],\n        }\n    )\n    return rows\n\n\ndef summarise_binary(series: pd.Series, min_cell: int) -> List[Dict[str, Any]]:\n    clean = series.dropna()\n    n = int(clean.shape[0])\n    if n < min_cell:\n        return [\n            {\n                \"statistic\": \"all_stats\",\n                \"value\": \"suppressed_lt_10\",\n                \"unweighted_n\": n,\n                \"detail\": \"Suppressed: non-missing N below privacy threshold.\",\n            }\n        ]\n\n    counts = clean.value_counts()\n    count1 = int(counts.get(1, 0))\n    count0 = int(counts.get(0, 0))\n    rows: List[Dict[str, Any]] = []\n\n    if count1 < min_cell or count0 < min_cell:\n        rows.append(\n            {\n                \"statistic\": \"prop_1\",\n                \"value\": \"suppressed_lt_10\",\n                \"unweighted_n\": n,\n                \"detail\": \"Suppressed: category count below privacy threshold.\",\n            }\n        )\n    else:\n        prop = clean.mean()\n        rows.append(\n            {\n                \"statistic\": \"prop_1\",\n                \"value\": round(float(prop), 4),\n                \"unweighted_n\": n,\n            }\n        )\n        rows.append(\n            {\n                \"statistic\": \"count_1\",\n                \"value\": count1,\n                \"unweighted_n\": n,\n            }\n        )\n        rows.append(\n            {\n                \"statistic\": \"count_0\",\n                \"value\": count0,\n                \"unweighted_n\": n,\n            }\n        )\n\n    missing_fraction = 1.0 - (n / series.shape[0])\n    rows.append(\n        {\n            \"statistic\": \"missing_fraction\",\n            \"value\": round(float(missing_fraction), 4),\n            \"unweighted_n\": series.shape[0],\n        }\n    )\n    return rows\n\n\ndef build_summary(\n    df: pd.DataFrame,\n    variables: List[VariableSpec],\n    min_cell: int,\n) -> List[Dict[str, Any]]:\n    results: List[Dict[str, Any]] = []\n    total_records = df.shape[0]\n\n    for spec in variables:\n        if spec.column not in df.columns:\n            results.append(\n                {\n                    \"variable_id\": spec.alias,\n                    \"source_column\": spec.column,\n                    \"statistic\": \"status\",\n                    \"value\": \"missing_column\",\n                    \"unweighted_n\": 0,\n                    \"note\": f\"{spec.column} not found in dataset.\",\n                }\n            )\n            continue\n\n        series = df[spec.column]\n        if spec.var_type == \"numeric\" or spec.var_type == \"ordinal\":\n            rows = summarise_numeric(series, min_cell)\n        elif spec.var_type == \"binary\":\n            rows = summarise_binary(series, min_cell)\n        else:\n            rows = [\n                {\n                    \"statistic\": \"status\",\n                    \"value\": \"unsupported_type\",\n                    \"unweighted_n\": int(series.dropna().shape[0]),\n                    \"detail\": f\"Unsupported var_type={spec.var_type}\",\n                }\n            ]\n\n        for row in rows:\n            enriched = {\n                \"variable_id\": spec.alias,\n                \"source_column\": spec.column,\n                \"variable_type\": spec.var_type,\n                \"statistic\": row.get(\"statistic\"),\n                \"value\": row.get(\"value\"),\n                \"unweighted_n\": row.get(\"unweighted_n\"),\n                \"detail\": row.get(\"detail\", \"\"),\n                \"note\": spec.note,\n                \"total_records\": total_records,\n            }\n            results.append(enriched)\n\n    return results\n\n\ndef parse_args() -> argparse.Namespace:\n    parser = argparse.ArgumentParser(\n        description=\"Generate deterministic exploratory summaries for key survey outcomes.\"\n    )\n    parser.add_argument(\"--csv\", required=True, help=\"Path to the survey CSV file.\")\n    parser.add_argument(\n        \"--config\",\n        default=\"config/agent_config.yaml\",\n        help=\"Path to the analysis agent configuration YAML.\",\n    )\n    parser.add_argument(\n        \"--out\",\n        default=\"tables/summary_key_outcomes.csv\",\n        help=\"Destination CSV for summary table.\",\n    )\n    parser.add_argument(\n        \"--min-cell-size\",\n        type=int,\n        default=None,\n        help=\"Override minimum cell size for suppression (defaults to config value).\",\n    )\n    return parser.parse_args()\n\n\ndef main() -> None:\n    args = parse_args()\n    config_path = Path(args.config)\n    config = load_yaml_config(config_path)\n    min_cell_size = resolve_min_cell_size(config, args.min_cell_size)\n    seed = resolve_seed(config)\n\n    random.seed(seed)\n    np.random.seed(seed)\n\n    csv_path = Path(args.csv)\n    if not csv_path.exists():\n        raise FileNotFoundError(f\"CSV not found: {csv_path}\")\n\n    df = pd.read_csv(csv_path, low_memory=False)\n\n    summary_rows = build_summary(df, KEY_VARIABLES, min_cell_size)\n    output_df = pd.DataFrame(summary_rows)\n\n    output_path = Path(args.out)\n    output_path.parent.mkdir(parents=True, exist_ok=True)\n    output_df.to_csv(output_path, index=False)\n\n    script_path = Path(__file__).resolve()\n    try:\n        script_ref = script_path.relative_to(Path.cwd().resolve())\n    except ValueError:\n        script_ref = script_path\n\n    manifest = {\n        \"seed\": seed,\n        \"min_cell_size\": min_cell_size,\n        \"records\": df.shape[0],\n        \"variables_summarised\": [spec.alias for spec in KEY_VARIABLES],\n        \"command\": f\"python {script_ref} --csv {args.csv} --config {args.config} --out {args.out}\",\n    }\n    manifest_path = output_path.with_suffix(\".json\")\n    with manifest_path.open(\"w\", encoding=\"utf-8\") as fh:\n        json.dump(manifest, fh, indent=2)\n\n    print(f\"Saved summary table to {output_path} and manifest to {manifest_path}\")\n\n\nif __name__ == \"__main__\":\n    main()\n",
      "mode": "text"
    },
    {
      "path": "tables/summary_key_outcomes.csv",
      "content": "variable_id,source_column,variable_type,statistic,value,unweighted_n,detail,note,total_records\nselfage,selfage,numeric,mean,30.4249,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,std,10.1689,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,min,18.0,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,q1,23.0,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,median,28.0,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,q3,35.0,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,max,75.0,14443,,Respondent age in years.,14443\nselfage,selfage,numeric,missing_fraction,0.0,14443,,Respondent age in years.,14443\nbiomale,biomale,binary,prop_1,0.5894,14443,,1=Biologically male; 0=otherwise. Confirm coding in codebook.,14443\nbiomale,biomale,binary,count_1,8512.0,14443,,1=Biologically male; 0=otherwise. Confirm coding in codebook.,14443\nbiomale,biomale,binary,count_0,5931.0,14443,,1=Biologically male; 0=otherwise. Confirm coding in codebook.,14443\nbiomale,biomale,binary,missing_fraction,0.0,14443,,1=Biologically male; 0=otherwise. Confirm coding in codebook.,14443\nreligion_current,religion,binary,prop_1,0.4962,14443,,1=Currently practices a religion; 0=otherwise.,14443\nreligion_current,religion,binary,count_1,2577.0,14443,,1=Currently practices a religion; 0=otherwise.,14443\nreligion_current,religion,binary,count_0,9958.0,14443,,1=Currently practices a religion; 0=otherwise.,14443\nreligion_current,religion,binary,missing_fraction,0.0,14443,,1=Currently practices a religion; 0=otherwise.,14443\nexternalreligion_importance,externalreligion,ordinal,mean,1.3699,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,std,1.3468,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,min,0.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,q1,0.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,median,1.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,q3,2.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,max,4.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nexternalreligion_importance,externalreligion,ordinal,missing_fraction,0.0,14443,,Importance of childhood religious adherence. Treated as ordered numeric scale.,14443\nnetworth_bracket,networth,ordinal,mean,2.0499,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,std,1.8992,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,min,-3.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,q1,1.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,median,2.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,q3,3.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,max,6.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nnetworth_bracket,networth,ordinal,missing_fraction,0.0,14443,,Current net worth bracket codes (higher=greater net worth).,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,mean,0.7466,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,std,1.9464,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,min,-3.0,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,q1,-1.0,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,median,1.0,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,q3,3.0,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,max,3.0,14436,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\nh33e6gg_adult_vs_child_happiness,\"On average, I am happier as an adult than I was in childhood (h33e6gg)\",ordinal,missing_fraction,0.0005,14443,,Higher values indicate greater adult vs childhood happiness; verify scale direction.,14443\n",
      "mode": "text"
    },
    {
      "path": "tables/summary_key_outcomes.json",
      "content": "{\n  \"seed\": 20251016,\n  \"min_cell_size\": 10,\n  \"records\": 14443,\n  \"variables_summarised\": [\n    \"selfage\",\n    \"biomale\",\n    \"religion_current\",\n    \"externalreligion_importance\",\n    \"networth_bracket\",\n    \"h33e6gg_adult_vs_child_happiness\"\n  ],\n  \"command\": \"python scripts/exploratory_summaries.py --csv childhoodbalancedpublic_original.csv --config config/agent_config.yaml --out tables/summary_key_outcomes.csv\"\n}",
      "mode": "text"
    },
    {
      "path": "notebooks/research_notebook.md",
      "content": "# Research Notebook (Bootstrap Scaffold)\n\n**Seed:** 20251016  \n**Regeneration command:** `python scripts/bootstrap_artifacts.py`\n\n## Session 0 Overview\n- Initialized repository structure and placeholder metadata files.\n- Documented initial hypotheses and PAP priorities (see `analysis/pre_analysis_plan.md`).\n- Recorded backlog items in `artifacts/state.json`.\n\n## Planned Next Entries\n1. Run exploratory weighted summaries for religion and happiness variables.\n2. Document QA checks and sync findings with `manuscript.tex`.\n3. Monitor sponsor communications for survey design metadata updates.\n\n> Update this notebook after each analysis loop with commands run, seeds used, and outputs generated.\n\n## Loop 1 - Survey Design Validation\n\n- **Commands:**  \n  - `python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv`  \n  - `python - <<'PY'` (counts rows; see `qc/design_validation.md`)\n- **Seed:** 20251016 (inherited; no stochastic procedures invoked).\n- **Outcome:** No survey weight, strata, cluster, or replicate columns detected. Updated `docs/survey_design.yaml`, `config/agent_config.yaml`, and `qc/data_checks.md`; recorded findings in `qc/design_validation.md`.\n\n## Loop 2 - Exploratory Summaries for Key Outcomes\n\n- **Commands:**  \n  - `python scripts/exploratory_summaries.py --csv childhoodbalancedpublic_original.csv --config config/agent_config.yaml --out tables/summary_key_outcomes.csv`\n- **Seed:** 20251016 (deterministic computation; no stochastic elements beyond fixed seed).\n- **Outputs:** `tables/summary_key_outcomes.csv`, `tables/summary_key_outcomes.json`\n- **Notes:** Generated unweighted descriptive statistics for priority outcomes because calibrated survey weights remain unavailable. All reported cells meet the minimum count threshold (>=10) enforced within the script.\n",
      "mode": "text"
    },
    {
      "path": "qc/data_checks.md",
      "content": "# Data Quality Checklist (Bootstrap)\n\n- [ ] Confirm file integrity for `childhoodbalancedpublic_original.csv` (checksum pending).\n- [x] Verify survey weight variable presence once metadata is populated in `docs/survey_design.yaml`. (2025-01-17; see `qc/design_validation.md`.)\n- [x] Inspect missingness for key variables (`religion`, `biomale`, `externalreligion`, `h33e6gg`). (2025-01-17; see `tables/summary_key_outcomes.csv`.)\n- [ ] Validate categorical coding against `docs/codebook.json` once completed.\n- [ ] Record any data issues and remediation steps here before analysis loops proceed.\n\n**Regeneration commands:**\n- `python scripts/bootstrap_artifacts.py`\n- `python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv`\n- `python scripts/exploratory_summaries.py --csv childhoodbalancedpublic_original.csv --config config/agent_config.yaml --out tables/summary_key_outcomes.csv`\n",
      "mode": "text"
    },
    {
      "path": "analysis/decision_log.csv",
      "content": "ts,action,inputs,rationale_short,code_path,outputs,status\n2025-11-03T17:46:46Z,bootstrap,\"[docs/codebook.json;docs/survey_design.yaml;config/agent_config.yaml]\",\"Initialized bootstrap artifacts and backlog\",\"scripts/bootstrap_artifacts.py\",\"[artifacts/state.json;analysis/hypotheses.csv;analysis/pre_analysis_plan.md]\",\"success\"\n2025-11-03T17:46:46Z,bootstrap,docs/codebook.json;docs/survey_design.yaml;config/agent_config.yaml,\"Seeded bootstrap artifacts, backlog, hypotheses, notebook scaffolds.\",scripts/bootstrap_artifacts.py,artifacts/state.json;analysis/hypotheses.csv;analysis/pre_analysis_plan.md,success\n2025-01-17T15:42:00Z,T-001 design validation,\"[childhoodbalancedpublic_original.csv;docs/survey_design.yaml;config/agent_config.yaml]\",\"Confirmed absence of design weights; assumed SRS defaults.\",\"scripts/design_scan.py\",\"[docs/survey_design.yaml;config/agent_config.yaml;qc/design_validation.md;artifacts/state.json]\",success\n2025-11-03T20:02:35Z,T-002 exploratory summaries,\"childhoodbalancedpublic_original.csv;config/agent_config.yaml\",\"Generated deterministic key outcome summaries under SRS assumption.\",scripts/exploratory_summaries.py,\"tables/summary_key_outcomes.csv;tables/summary_key_outcomes.json\",success\n",
      "mode": "text"
    },
    {
      "path": "artifacts/state.json",
      "content": "{\n  \"artifacts\": {\n    \"hypotheses_registry\": \"analysis/hypotheses.csv\",\n    \"pre_analysis_plan\": \"analysis/pre_analysis_plan.md\",\n    \"research_notebook\": \"notebooks/research_notebook.md\"\n  },\n  \"backlog\": [\n    {\n      \"description\": \"Validate survey weights and replicate design metadata\",\n      \"id\": \"T-001\",\n      \"priority\": 1,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Generate exploratory weighted summaries for key outcomes\",\n      \"id\": \"T-002\",\n      \"priority\": 2,\n      \"status\": \"done\"\n    },\n    {\n      \"description\": \"Monitor for sponsor-provided survey design metadata updates\",\n      \"id\": \"T-003\",\n      \"priority\": 3,\n      \"status\": \"todo\"\n    }\n  ],\n  \"bootstrap_complete\": true,\n  \"loop_counter\": 2,\n  \"next_actions\": [\n    \"T-003\"\n  ],\n  \"regeneration_commands\": {\n    \"bootstrap\": \"python scripts/bootstrap_artifacts.py\",\n    \"design_validation\": \"python scripts/design_scan.py --csv childhoodbalancedpublic_original.csv\",\n    \"exploratory_summaries\": \"python scripts/exploratory_summaries.py --csv childhoodbalancedpublic_original.csv --config config/agent_config.yaml --out tables/summary_key_outcomes.csv\"\n  },\n  \"seed\": 20251016,\n  \"total_loops\": 30\n}\n",
      "mode": "text"
    }
  ],
  "decision_log_row": {
    "ts": "2025-11-03T20:02:35Z",
    "action": "T-002 exploratory summaries",
    "inputs": ["childhoodbalancedpublic_original.csv", "config/agent_config.yaml"],
    "rationale_short": "Created deterministic summaries for key outcomes under SRS assumption.",
    "code_path": "scripts/exploratory_summaries.py",
    "outputs": ["tables/summary_key_outcomes.csv", "tables/summary_key_outcomes.json"],
    "status": "success"
  },
  "next_actions": [
    {
      "id": "T-003",
      "priority": 3,
      "desc": "Monitor for sponsor-provided survey design metadata updates",
      "estimate_min": "10m"
    }
  ],
  "state_update": {
    "loop_counter": 2
  },
  "git": {
    "commit": true,
    "message": "feat(summary): add key outcome descriptive table"
  },
  "stop_now": false,
  "stop_reason": "",
  "signals": []
}
```